{
  "$schema": "http://json-schema.org/draft-03/schema#",
  "type": "object",
  "title": "Kronos configuration file format",
  "description": "The Kronos-core configuration file format controls the execution of the modelling algorithm",
  "additionalProperties": false,
  "properties": {
    "verbose": {
      "type": "boolean"
    },
    "dir_input": {
      "type": "string",
      "required": true,
      "description": "Folder of KPF format file"
    },
    "dir_output": {
      "type": "string",
      "required": true,
      "description": "Working output folder"
    },
    "kpf_files": {
      "type": "array",
      "required": true,
      "description": "List of KPF input files",
      "items": {
        "type": "string"
      }
    },
    "ksf_filename": {
      "type": "string",
      "required": true,
      "description": "Name of KSF (schedule) output file"
    },
    "model": {
      "type": "object",
      "required": false,
      "description": "Modelling process",
      "properties": {
        "fill_in": {
          "type": "object",
          "required": false,
          "description": "Methodologies for dealing with sparse data",
          "properties": {
            "user_functions": {
              "type": "array",
              "required": false,
              "description": "User-defined functions that can be used to attach values to missing metrics",
              "items": {
                "type": "object",
                "oneOf": [
                  {
                    "type": "object",
                    "description": "Step function for job-metrics",
                    "properties": {
                      "type": {
                        "type": "string",
                        "required": true,
                        "description": "Step function identifier",
                        "enum": ["step"]
                      },
                      "name": {
                        "type": "string",
                        "required": true,
                        "description": "Function name"
                      },
                      "x_step": {
                        "type": "number",
                        "required": true,
                        "description": "x of th step within the job duration, normalized in [0,1]"
                      }
                    },
                    "additionalProperties": false
                  },
                  {
                    "type": "object",
                    "description": "User-defined generic function for job-metrics (values normalized in [0,1]",
                    "properties": {
                      "type": {
                        "type": "string",
                        "required": true,
                        "description": "Custom function identifier",
                        "enum": ["custom"]
                      },
                      "name": {
                        "type": "string",
                        "required": true,
                        "description": "Function name"
                      },
                      "x_values": {
                        "type": "array",
                        "required": true,
                        "description": "Time values in [0,1] (normalized against the job duration)",
                        "items": {
                          "type": "number"
                        }
                      },
                      "y_values": {
                        "type": "array",
                        "required": true,
                        "description": "Function values in [0,1]",
                        "items": {
                          "type": "number"
                        }
                      }
                    },
                    "additionalProperties": false
                  }
                ]
              }
            },
            "operations": {
              "type": "array",
              "required": true,
              "description": "Operations to be applied to profiled workload jobs",
              "items": {
                "type": "object",
                "oneOf": [
                  {
                    "type": "object",
                    "description": "Filling job metrics operation",
                    "properties": {
                      "type": {
                        "type": "string",
                        "required": true,
                        "description": "Operation that manually replaces missing job metrics with user-defined values",
                        "enum": ["fill_missing_entries"]
                      },
                      "apply_to": {
                        "type": "array",
                        "required": true,
                        "description": "Array of names of the workloads to which these metrics should be applied to",
                        "items": {
                          "type": "string"
                        }
                      },
                      "priority": {
                        "type": "integer",
                        "required": true,
                        "description": "Level of priority (0 to 10) to be assigned to job-metrics \n- only metrics with lower priority, will be replaced"
                      },
					  "metrics": {
                        "type": "object",
                        "required": true,
                        "description": "Metrics attached to each job record",
                        "additionalProperties": false,
                        "patternProperties": {
                          "(n_write|n_read|kb_write|kb_read|n_pairwise|kb_pairwise|n_collective|kb_collective|flops)": {
                            "description": "",
                            "oneOf": [
                              {
                                "type": "array",
                                "required": true,
                                "description": "A random value is generated within the provided interval [val_min, val_max]",
                                "items": {
                                  "type": "number"
                                }
                              },
                              {
                                "type": "object",
                                "properties": {
                                  "function":{
                                    "type": "string",
                                    "required": true,
                                    "description": "Name of user-defined function to be used for defining values"
                                  },
                                  "scaling":{
                                    "type": "number",
                                    "required": true,
                                    "description": "Scaling factor that multiplies the user-defined function values"
                                  }
                                }
                              }
                            ]
                          }
                        }
                      }
                    }
                  },
                  {
                    "type": "object",
                    "description": "Function that maps job metrics of one job into similar jobs in a workload",
                    "properties": {
                      "type": {
                        "type": "string",
                        "required": true,
                        "description": "Function identification string",
                        "enum": ["match_by_keyword"]
                      },
                      "priority": {
                        "type": "integer",
                        "required": true,
                        "description": "Level of priority (0 to 10) to be assigned to job-metrics \n- only metrics with lower priority, will be replaced"
                      },
                      "keywords": {
                        "type": "array",
                        "required": true,
                        "description": "only jobs that match according to these keywords are considered similar",
                        "items": {
                          "type": "string",
                          "enum": ["label", "name"]
                        }
                      },
                      "similarity_threshold": {
                        "type": "number",
                        "required": true,
                        "description": "similarity threshold above which two jobs are considered similar"
                      },
                      "source_workloads": {
                        "type": "array",
                        "required": true,
                        "description": "list of workloads from which job metrics are taken",
                        "items": {
                          "type": "string",
                          "description": "Workload from which profiled job records are taken"
                        }
                      },
                      "apply_to": {
                        "type": "array",
                        "required": true,
                        "description": "Workloads whose jobs receive the metrics",
                        "items": {
                          "type": "string"
                        }
                      }
                    }
                  }


                ]
              }
            }
          }
        },
        "classification": {
          "type": "object",
          "required": false,
          "description": "Job-classification process",
          "properties": {
            "operations": {
              "type": "array",
              "description": "Operations to perform on the workloads before clustering (e.g., workload splitting)",
              "items": {
                "type": "object",
                "oneOf": [

                  {
                  "type": "object",
                  "description": "Workload splitting function",
                  "properties": {
                    "type": {
                      "type": "string",
                      "required": true,
                      "description": "Function identification keyword (workload split function)",
                      "enum": ["split"]
                    },
                    "apply_to": {
                      "type": "string",
                      "required": true,
                      "description": "Workloads to split"
                    },
                    "create_workload": {
                      "type": "string",
                      "required": true,
                      "description": "Name of the workload generated by the split function"
                    },
                    "split_by": {
                      "type": "string",
                      "required": true,
                      "description": "Job property to use splitting",
                      "enum": ["label", "job_name", "user_name", "cmd_str", "queue_name"]
                    },
                    "keywords_in": {
                      "type": "array",
                      "required": true,
                      "description": "Search keywords *included*",
                      "items": {
                        "type": "string"
                      }
                    },
                    "keywords_out": {
                      "type": "array",
                      "required": true,
                      "description": "Search keywords *excluded*",
                      "items": {
                      "type": "string"
                      }
                    }
                  },
                  "additionalProperties": false
                 }
              	]
              }
            },

            "clustering": {
              "type": "object",
              "description": "Clustering algorithm",
              "oneOf": [

              {
                "type": "object",
                "description": "K-means Clustering algorithm",
                "properties": {
                  "apply_to": {
                    "type": "array",
                    "required": true,
                    "description": "list of workload to which apply clustering",
                    "items": {
                      "type": "string"
                    }
                  },
                  "type": {
                    "type": "string",
                    "required": true,
                    "description": "type of clustering algorithm",
                    "enum": ["Kmeans"]
                  },
                  "ok_if_low_rank": {
                    "type": "boolean",
                    "required": true,
                    "description": "keep going even if there are just few distinct elements in the input set"
                  },
                  "user_does_not_check": {
                    "type": "boolean",
                    "required": true,
                    "description": "if True, the algorithm does not stop"
                  },
                  "rseed": {
                    "type": "integer",
                    "required": true,
                    "description": "Seed for random number generator"
                  },
                  "max_iter": {
                    "type": "integer",
                    "required": true,
                    "description": "max iteration of the algorithm"
                  },
                  "max_num_clusters": {
                    "type": "integer",
                    "required": true,
                    "description": "max number of clusters to explore to find the optimum"
                  },
                  "delta_num_clusters": {
                    "type": "integer",
                    "required": true,
                    "description": "delta number of clusters to explore to find the optimum"
                  },
                  "num_timesignal_bins": {
                    "type": "integer",
                    "required": true,
                    "description": "number of bins to discretize the job metrics for applying the clustering"
                  }
                }
              },

              {
                "type": "object",
                "description": "DBSCAN Clustering algorithm",
                "properties": {
                  "apply_to": {
                    "type": "array",
                    "required": true,
                    "description": "list of workload to which apply clustering",
                    "items": {
                      "type": "string"
                    }
                  },
                  "type": {
                    "type": "string",
                    "required": true,
                    "description": "type of clustering algorithm",
                    "enum": ["DBSCAN"]
                  },
                  "rseed": {
                    "type": "integer",
                    "required": true,
                    "description": "Seed for random number generator"
                  },
                  "max_num_clusters": {
                    "type": "integer",
                    "required": true,
                    "description": "max number of clusters to explore to find the optimum"
                  },
                  "num_timesignal_bins": {
                    "type": "integer",
                    "required": true,
                    "description": "number of bins to discretize the job metrics for applying the clustering"
                  }
                }
              }


             ]
            }
          }
        },
        "generator": {
          "type": "object",
          "required": true,
          "description": "configuration for generating synthetic apps",
          "properties": {
            "type": {
              "type": "string",
              "required": true,
              "enum": ["match_job_pdf","match_job_pdf_exact"],
              "description": "PDF distribution of profiled jobs to generate the synth apps: \n\n- match_job_pdf_exact: synth apps are scheduled to result in a perfect \n  match with the profiled jobs PDF (intended as how probable a job is to be scheduled \n  in a certain interval of time relative to the duration of the  synthetic schedule)]\n\n- match_job_pdf: synthetic apps are randomly generated from a PDF that matches the profiled jobs PDF\n"
            },
            "n_bins_for_pdf": {
              "type": "integer",
              "required": true,
              "description": "Number of bins for calculating the PDF of the schedule"
            },
            "random_seed": {
              "type": "integer",
              "required": true,
              "description": "Seed for random number generation"
            },
            "tuning_factors": {
              "type": "object",
              "required": true,
              "description": "user-defined scaling factors of the job metrics",
              "patternProperties": {
                "(n_write|n_read|kb_write|kb_read|n_pairwise|kb_pairwise|n_collective|kb_collective|flops)": {
                  "type": "number"
                }
              }
            },
            "submit_rate_factor": {
              "type": "number",
              "required": true,
              "description": "Scaling factor of the job submission rate"
            },
            "synthapp_n_cpu": {
              "type": "integer",
              "required": true,
              "description": "N cpus to be used to run each synthetic application"
            },
            "synthapp_n_nodes": {
              "type": "integer",
              "required": true,
              "description": "N nodes to be used to run each synthetic application"
            },
            "synthapp_n_frames": {
              "type": "integer",
              "required": true,
              "description": "N-frames used to discretise each synthetic application"
            },
            "total_submit_interval": {
              "type": "integer",
              "required": true,
              "description": "Total time interval within which synthetic applications are submitted"
            }
          }
        }
      }
    }
  }
}