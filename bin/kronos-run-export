#!/usr/bin/env python
# (C) Copyright 1996-2017 ECMWF.
#
# This software is licensed under the terms of the Apache Licence Version 2.0
# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.
# In applying this licence, ECMWF does not waive the privileges and immunities
# granted to it by virtue of its status as an intergovernmental organisation nor
# does it submit to any jurisdiction.

import argparse

from kronos.core.post_process.sim_set import SimulationSet
from kronos.core.post_process import writer_map
from kronos.core.post_process.export_config.export_config import ExportConfig
from kronos.core.post_process.sim_data import SimulationData

if __name__ == "__main__":

    # Read other arguments if present..
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('export_config', help="Export configuration file (.kef)")
    args = parser.parse_args()

    # Read the export config
    config = ExportConfig.from_json_file(args.export_config)

    # Labelled list of simulations
    labelled_kronos_sims = [SimulationData.read_from_sim_paths(path, tag, n_procs_node=config.n_procs_node)
                            for tag, path in zip(config.experiment_list, config.experiment_paths)]

    # Pre-calculate data ready for export
    sim_set = SimulationSet(labelled_kronos_sims)

    # Retrieve job classes common for all the simulation in the set
    common_job_classes = sim_set.retrieve_common_job_classes(config.job_classes)
    print "common_job_classes: {}".format(common_job_classes)

    # calculate statistics on the common job classes
    sim_set.calculate_class_stats_sums(common_job_classes)

    # for sim in sim_set.sims:
    #     sim.print_job_classes_info(common_job_classes)

    # Export results as per user requests
    for export_config in config.exports:
        data_writer = writer_map[export_config["type"]](sim_set=sim_set)
        data_writer.export(export_config=export_config,
                           output_path=config.output_path,
                           job_classes=common_job_classes)
